{% set lastSeenComparePeriod = false %}
{%- for rowId, row in dataTable.getRows() -%}
    {% set comparePeriod = row.getMetadata('comparePeriodPretty') %}
    {% if lastSeenComparePeriod != comparePeriod %}
    <tr class="comparePeriod">
        <td colspan="{{ properties.columns_to_display|length }}">
            {{ comparePeriod }}
        </td>
    </tr>
    {% endif %}
    {% set overrideParams = {} %}

    {% if row.getMetadata('compareSegment')|default is not empty %}{% set overrideParams = overrideParams|merge({ segment: row.getMetadata('compareSegment'), compareSegments: '' }) %}{% endif %}
    {% if row.getMetadata('comparePeriod')|default is not empty %}{% set overrideParams = overrideParams|merge({ period: row.getMetadata('comparePeriod'), comparePeriods: '' }) %}{% endif %}
    {% if row.getMetadata('compareDate')|default is not empty %}{% set overrideParams = overrideParams|merge({ date: row.getMetadata('compareDate'), compareDates: '' }) %}{% endif %}
    <tr
        class="comparisonRow"
        data-param-override="{{ overrideParams|json_encode|e('html_attr') }}" data-label="{{ comparedRow.getColumn('label')|e('html_attr') }}"
        {% if row.getMetadata('segment') is not false %}data-segment-filter="{{ row.getMetadata('segment')|e('html_attr') }}"{% endif %}
    >
        <td>
            {%- set comparisonLabel = row.getMetadata('compareSegmentPretty') -%}
            <span class="label">{{ comparisonLabel }}</span>
        </td>
        {% for column in properties.columns_to_display %}
        {% if column != 'label' %}
        {% set columnValue = row.getColumn(column) %}
        <td>
            {% set columnChange = row.getColumn(column ~ '_change')|default('+0%') %}
            {% set comparisonTotals = indexedComparisonTotals[row.getMetadata('compareSegment')|default('')][row.getMetadata('comparePeriod')|default('')][row.getMetadata('compareDate')|default('')]|default(null) %}

            {% include "@CoreVisualizations/_dataTableViz_htmlTable_ratio.twig" with {
                'changePercentage': columnChange,
                'totals': comparisonTotals,
                'label': comparisonLabel,
                'labelColumn': properties.columns_to_display|first,
                'changePercantage': columnChange,
                'forceZero': true
            } %}
            <span class="value">{{ columnValue|number(2,0)|rawSafeDecoded }}</span>
        </td>
        {% endif %}
        {% endfor %}
    </tr>
    {% set lastSeenComparePeriod = comparePeriod %}
{%- endfor -%}
